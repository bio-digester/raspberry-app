<div id="page-wrapper">
  <div class="row">
    <div class="col-lg-12">
      <h1 class="page-header">Visão geral do sistema</h1>
    </div>
    <!-- /.col-lg-12 -->
  </div>
  <% if flash[:notice] %>
  <div id="notice" class="alert alert-success alert-dismissable">
    <button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>
    <%= notice %>
  </div>
  <% end %>


  <h2 id='tituloH2' style="display: none;"></h2>
  <div id='notificacaoDiv' style="width:100%; display: none;"></div>

  <!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
          <h4 class="modal-title" id="myModalLabel">Detalhes da Notificação</h4>
        </div>
        <div class="modal-body">

        </div>
        <div class="modal-footer">

        </div>
      </div>
      <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
  </div>
  <!-- /.modal -->

  <!-- /.row -->
  <div class="row">

    <!-- Temperatura -->
    <div class="col-lg-3 col-md-6">
      <div class="panel panel-red">
        <div class="panel-heading">
          <div class="row">
            <div class="col-xs-3">
              <i class="fa fa-thermometer fa-2x"></i>
            </div>
            <div class="col-xs-9 text-right">
              <% if @temperature.last != nil %>
              <div class="huge"><%= '%.2f' % @temperature.last.value%> ºC</div>
              <%=@temperature.last.data_measure.strftime("%d/%m/%Y - %I:%M %p")%>
              <% else %>
              <div class="huge"> 0 dados</div>
              <% end %>

              <div>Temperatura</div>
            </div>
          </div>
        </div>
        <div class="panel-footer">
          <%= link_to "Visualizar Detalhes", sensor_path(@sensors.find_by(name: "TEMPDS")) %>
          <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
          <div class="clearfix"></div>
        </div>
      </div>
    </div>

    <!-- volume -->
    <div class="col-lg-3 col-md-6">
      <div class="panel panel-green">
        <div class="panel-heading">
          <div class="row">
            <div class="col-xs-2">
              <i class="fa fa-level-up fa-2x"></i>
            </div>
            <div class="col-xs-10 text-right">
              <% if @level.last != nil %>
              <div class="huge"><%= '%.2f' % @level.last.value %> cm³</div>
              <%=@level.last.data_measure.strftime("%d/%m/%Y - %I:%M %p")%>
              <% else %>
              <div class="huge"> 0 dados</div>
              <% end %>
              <div>Volume</div>
            </div>
          </div>
        </div>
        <div class="panel-footer">
          <%= link_to "Visualizar Detalhes", sensor_path(@sensors.find_by(name: "LEVEL")) %>
          <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
          <div class="clearfix"></div>
        </div>
      </div>
    </div>

    <!-- Pressão -->
    <div class="col-lg-3 col-md-6">
      <div class="panel panel-yellow">
        <div class="panel-heading">
          <div class="row">
            <div class="col-xs-2">
              <i class="fa fa-tachometer   fa-2x"></i>
            </div>
            <div class="col-xs-10 text-right">
              <% if @pressure.last != nil %>
              <div class="huge"><%='%.2f' %  @pressure.last.value %> kPa</div>
              <%=@pressure.last.data_measure.strftime("%d/%m/%Y - %I:%M %p")%>
              <% else %>
              <div class="huge"> 0 dados</div>
              <% end %>
              <div>Pressão</div>
            </div>
          </div>
        </div>
        <div class="panel-footer">
          <%= link_to "Visualizar Detalhes", sensor_path(@sensors.find_by(name: "PRESSURE")) %>
          <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
          <div class="clearfix"></div>
        </div>
      </div>
    </div>

    <!-- PH -->

    <div class="col-lg-3 col-md-6">
      <div class="panel panel-primary">
        <div class="panel-heading">
          <div class="row">
            <div class="col-xs-3">
              <i class="fa fa-thermometer fa-2x"></i>
            </div>
            <div class="col-xs-9 text-right">
              <% if @ph.last != nil %>
              <div class="huge"><%= '%.2f' % @ph.last.value%></div>
              <%=@ph.last.data_measure.strftime("%d/%m/%Y - %I:%M %p")%>
              <% else%>
              <div class="huge"> 0 dados</div>
              <% end %>
              <div>pH</div>
            </div>
          </div>
        </div>
        <div class="panel-footer">
          <%= link_to "Visualizar Detalhes", sensor_path(@sensors.find_by(name: "PH")) %>
          <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
          <div class="clearfix"></div>
        </div>
      </div>
    </div>

    <!-- Concentration -->

    <div class="col-lg-3 col-md-6">
      <div class="panel panel-default">
        <div class="panel-heading">
          <div class="row">
            <div class="col-xs-3">
              <i class="fa fa-thermometer fa-2x"></i>
            </div>
            <div class="col-xs-9 text-right">
              <% if @methane_gas.last != nil %>
                <div class="huge"><%= '%.2f' % @methane_gas.last.value%> ppm</div>
                <%=@methane_gas.last.data_measure.strftime("%d/%m/%Y - %I:%M %p")%>
              <% else %>
              <div class="huge"> 0 dados</div>
              <% end %>
              <div>Concentração</div>
            </div>
          </div>
        </div>
        <div class="panel-footer">
          <%= link_to "Visualizar Detalhes", sensor_path(@sensors.find_by(name: "CONCENTRATION")) %>
          <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
          <div class="clearfix"></div>
        </div>
      </div>
    </div>

  </div>
  <!-- /.row -->
  <div class="row">
    <div class="col-lg-8">

      <!-- Gráfico de Concentração -->
      <% if @data_collects.last(50) != nil %>
      <div class="panel panel-default">
        <div class="panel-heading">
          <center><i class="fa fa-bar-chart-o fa-fw"></i> 50 últimos dados coletados / Horário do Registro</center>
          <div class="pull-right">
            <div class="btn-group">

            </div>
          </div>
        </div>
        <!-- /.panel-heading -->
        <div class="panel-body">
          <div id="principal"><%= line_chart  get_last_fifty_all_path , adapter: "highcharts", refresh: 5, xtitle: "Tempo (hh:mm:ss)", ytitle: "Sensores"%></div>
        </div>
        <!-- /.panel-body -->
      </div>
      <% end %>

    </div>

    <div class="col-lg-4">
      <!-- /.panel -->
      <div class="panel panel-default">
        <div class="panel-heading">
          <center><i class="fa fa-bar-chart-o fa-fw"></i> Volume de dados por Sensor</center>
        </div>
        <div class="panel-body">
          <div id="morris-donut-chart"><%= column_chart @dataCollectedFromSensorsWithName, ytitle: "Quantidade de dados", xtitle: "Nome do sensor" %></div>
        </div>
        <!-- /.panel-body -->
      </div>
      <!-- /.panel -->
      <!-- /.panel .chat-panel -->
    
    </div>
    <div class="col-lg-12">
      <!-- /.panel -->
      <div class="panel panel-default">
        <div class="panel-heading">
          <center><i class="fa fa-bar-chart-o fa-fw"></i> Volume de Dados Coletados Por Dia</center>
          <div class="pull-right">
            <div class="btn-group">

            </div>
          </div>
        </div>
        <!-- /.panel-heading -->
        <div class="panel-body">
          <div id="morris-bar-chart"><%= column_chart @data_collects.group_by_day(:data_measure).count, ytitle: "Quantidade de dados", xtitle: "Data"  %></div>
        </div>
        <!-- /.panel-body -->

    </div>
    

  </div> <!--    Fechar div aqui -->

    <!-- /.col-lg-4 -->
  <!-- /.row -->
</div>
<!-- /#page-wrapper -->

</div>
<script>
  $( document ).ready(function() {
    var highchartsOptions = Highcharts.setOptions({
      lang: {
            loading: 'Aguarde...',
            months: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'],
            weekdays: ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'],
            shortMonths: ['Jan', 'Fev', 'Mar', 'Abr', 'Maio', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
            exportButtonTitle: "Exportar",
            printButtonTitle: "Imprimir",
            rangeSelectorFrom: "De",
            rangeSelectorTo: "Até",
            rangeSelectorZoom: "Periodo",
            downloadPNG: 'Download imagem PNG',
            downloadJPEG: 'Download imagem JPEG',
            downloadPDF: 'Download documento PDF',
            downloadSVG: 'Download imagem SVG'
            // resetZoom: "Reset",
            // resetZoomTitle: "Reset,
            // thousandsSep: ".",
            // decimalPoint: ','
            }
      }
  );

  });
</script>

<!-- /#wrapper -->
<script>
console.log("entrou no script")
var id = 0;
var id_closed_notification = []
setInterval(updateNotification, 1000);

function preparaDiv(id, message){
  div = document.createElement("div");

  div.id = id
  div.classList.add("alert");
  div.classList.add("alert-danger");
  div.classList.add("alert-dismissable");
  div.innerHTML = message + ". ";

  return div;
}

function preparaBotao(id){
  botao = document.createElement("button");
  botao.id = id
  botao.classList.add("close");
  botao.setAttribute("type" , "button");
  botao.setAttribute("data-dismiss" , "alert");
  botao.setAttribute("aria-hidden" , "true");
  botao.innerHTML = "x";
  botao.onclick = function() { id_closed_notification.push(id)};
  return botao;
}

function preparaLink(id){
  a = document.createElement("a")
  a.id = id
  a.innerHTML = "mais informações"
  a.setAttribute("data-toggle" , "modal");
  a.setAttribute("data-target" , "#myModal" + id);

  return a;
}

function criaModalPai(id){
  modalPai = document.createElement("div");
  modalPai.id = "myModal" + id;
  modalPai.setAttribute("tabindex" , "-1");
  modalPai.setAttribute("role" , "dialog");
  modalPai.setAttribute("aria-labelledby" , "myModalLabel");
  modalPai.setAttribute("aria-hidden" , "true");
  modalPai.classList.add("modal");
  modalPai.classList.add("fade");

  return modalPai;
}

function criaModalFilha(){
  divFilha = document.createElement("div");
  divFilha.classList.add("modal-dialog");

  return divFilha;
}

function criaDivFilhaFilha(){
  divFilhaFilha = document.createElement("div");
  divFilhaFilha.classList.add("modal-content");

  return divFilhaFilha;
}

function criaDivHeader(id){
  divHeader = document.createElement("div");
  divHeader.classList.add("modal-header");

  h4 = document.createElement("H4");
  h4.classList.add("modal-title");
  h4.innerHTML = "Detalhes da Notificação";


  botaoModal = document.createElement("button");
  botaoModal.classList.add("close");
  botaoModal.setAttribute("type" , "button");
  botaoModal.setAttribute("data-dismiss" , "modal");
  botaoModal.setAttribute("aria-hidden" , "true");
  botaoModal.innerHTML = "x";

  divHeader.appendChild(botaoModal);
  divHeader.appendChild(h4);

  // <h4 id="myModalLabel"></h4>
  return divHeader;
}

function criaDivBody(message){
  divBody = document.createElement("div");
  divBody.classList.add("modal-body");
  divBody.innerHTML = message;

  return divBody;
}

function criaDivFooter(id, message){
  divFooter = document.createElement("div");
  divFooter.classList.add("modal-footer");

  botaoFecharModal = document.createElement("button");
  botaoFecharModal.setAttribute("data-dismiss" , "modal");

  botaoFecharModal.innerHTML = "Marcar como lido";
  botaoFecharModal.onclick = function() { lerNotificacao(id) };

  message1 = "[WARNING] O volume de alimentação está no limite, retire o biofertilizante";
  message2 = "[WARNING] Retire o Biogás";

  if(message.localeCompare(message1) == 0 ||
     message.localeCompare(message2) == 0 ){
    botaoFecharModal.innerHTML = "Gás removido";
    botaoAux = document.createElement("button");
    botaoAux.innerHTML = "Remover Gás";
    botaoAux.onclick = function(){ mandaProVinicius()}
    divFooter.appendChild(botaoAux);
  }

  divFooter.appendChild(botaoFecharModal);

  return divFooter;
}

function mandaProVinicius(){
  $.get('../send_first_socket_message', function(retorno){});
}

function lerNotificacao(id){
  console.log("ler notificação com o id: " + id);
  $.get('../read_notification', { id: id },  function(retorno){
    return
  });
}

function removerIdsFechados(id_closed_notification, notificacoes){
  var index = 0;
  for(index = 0 ; index < notificacoes.length ; index++){
    for(index1 = 0 ; index1 < id_closed_notification.length ; index1++){
      if(notificacoes[index] != undefined){
        if(notificacoes[index].id == id_closed_notification[index1]){
          notificacoes.splice(index, 1);
        }
      }
    }
  }
  return notificacoes;
}

function updateNotification(){
  $.get('../get_last_notification', function(notificacoes){
    notificacoes = removerIdsFechados(id_closed_notification, notificacoes);

    if(notificacoes){
      notificacaoDiv = document.getElementById('notificacaoDiv')
      if(notificacaoDiv != undefined && notificacaoDiv != null){
        notificacaoDiv.style.display = "inline-block";
        while (notificacaoDiv.firstChild) {
          notificacaoDiv.removeChild(notificacaoDiv.firstChild);
        }
      }

      var h2 = document.getElementById('tituloH2')
      if(h2 != null){
        h2.style.display = "block";
        h2.innerHTML = "Você possui " + notificacoes.length +  " notificações"
      }

      vezAtual = 0;
      qtdVezes = notificacoes.length;
      if(notificacoes[vezAtual] != undefined){
          do{
            div = preparaDiv(id, notificacoes[vezAtual].message);
            botao = preparaBotao(notificacoes[vezAtual].id);
            a = preparaLink(id)
            modalPai = criaModalPai(id);
            divFilha = criaModalFilha();
            divFilhaFilha = criaDivFilhaFilha();

            divHeader = criaDivHeader();
            divBody = criaDivBody(notificacoes[vezAtual].message);

            divFooter = criaDivFooter(notificacoes[vezAtual].id,
                                      notificacoes[vezAtual].message );

            divFilhaFilha.appendChild(divHeader);
            divFilhaFilha.appendChild(divBody);
            divFilhaFilha.appendChild(divFooter);
            divFilha.appendChild(divFilhaFilha);
            modalPai.appendChild(divFilha);
            div.appendChild(botao);
            div.appendChild(a);
            document.getElementById('notificacaoDiv').appendChild(div);
            document.getElementById('page-wrapper').appendChild(modalPai);

            vezAtual++;
            id++;
          }while(vezAtual < qtdVezes)
        }
      id = 0;
    }else{
      notificacaoDiv = document.getElementById('notificacaoDiv')
      notificacaoDiv.style.display = "none";
      document.getElementById('tituloH2').style.display = "none";
    }

  });
  // document.location.href = "http://localhost:3000/get_last_notification";
}
</script>

<!-- jQuery -->
<!-- <script src="../vendor/jquery/jquery.min.js"></script> -->

<!-- Bootstrap Core JavaScript -->
<!-- <script src="../vendor/bootstrap/js/bootstrap.min.js"></script> -->

<!-- Metis Menu Plugin JavaScript -->
<!-- <script src="../vendor/metisMenu/metisMenu.min.js"></script> -->

<!-- Morris Charts JavaScript -->
<!-- <script src="../vendor/raphael/raphael.min.js"></script>
<script src="../vendor/morrisjs/morris.min.js"></script>
<script src="../data/morris-data.js"></script> -->

<!-- Custom Theme JavaScript -->
<!-- <script src="../dist/js/sb-admin-2.js"></script> -->
